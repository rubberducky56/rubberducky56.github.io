---
layout: post
title: "Malware Analysis At A Glance"
author: "Mouse"
categories: cybersecurity
tags: [cybersecurity, programming, malware, reverse-engineering]
image: malware_analysis.png
permalink: /cybersecurity/malware-analysis-glance
---

### What is Malware?

__Malware__, or malicious software, is software designed to cause harm to a system or network. It is common for malware to have mechanisms built in to spread itself throughout a system, remain undetectable, damage data, and render a computer unusable.

One famous example of malware is __Stuxnet__. In January 2010, a routine inspection of the Natanz Uranium Enrichment Plant in Iran was carried out by the International Atomic Energy Agency. They found that many centrifuges were failing, but no cause was specified. Later in 2010, a number of computer systems in the plant were crashing and rebooting. When technicians analysed the computer for __IoCs__, or __Indicators of Compromise__, they found numerous malicious files installed. Those technicians had just discovered one of the most infamous pieces of malware ever cooked up - Stuxnet.

Stuxnet spread itself through Windows PCs and USB sticks until it found its way into the Natanz plant. When critical __SCADA__ (Supervisory Control and Data Acquisition) systems, such as nuclear gas centrifuges, were infected, the malware caused them to malfunction. The Natanz centrifuges would essentially tear themselves apart.

Stuxnet was an extremely sophisticated, targeted attack which severely crippled Iran’s nuclear weapons program. It is speculated that Stuxnet was built as a cyber weapon as a collaboration between US and Israeli intelligence agencies, but neither have since claimed responsibility. Stuxnet was the first demonstration of malware being used to cause significant physical damage, and bring a country’s nuclear program to its knees.

This article is an introduction to malware, and will discuss some basic malware analysis techniques. Malware analysis is a huge area, so I will only be scratching the surface. This article is loosely based off the [TryHackMe malware module](https://tryhackme.com/module/malware-analysis).

### Types of Malware

Malware campaigns generally come in two flavours:
1. __Targeted campaigns__ - created for a specific purpose for a specific target
>The Stuxnet malware campaign was targeted - it was targeting Iranian nuclear facilities

2. __Mass campaigns__ - the aim is to infect as many devices as possible, and are usually run by __APT__ groups, or __Advanced Persistent Threat__ groups.
>In April 2022, Bitdefender detailed a mass malware campaign using _RedLine Stealer_ - a data harvesting piece of malware that can steal passwords, usernames and credit card data on Windows PCs. RedLine Stealer is often sold on underground forums as _malware-as-a-service_. This is when novices can buy malware off the shelf and execute their own malware campaigns. Bitdefender’s whitepaper can be downloaded from [here](https://www.bitdefender.com/blog/labs/redline-stealer-resurfaces-in-fresh-rig-exploit-kit-campaign/).

Malware can come in all shapes and sizes, and some common malware types are listed below. Note that some definitions have no consensus - I will be using the definitions coined by Fortinet.

* __Viruses__ - Malware which can propagate through a system, but requires human intervention
  * __File viruses__ - These infect files on a system, often executables, and can infect other files when opened
  * __Macro viruses__ - Microsoft Office products allow users to write small programs to automate repetitive tasks, called macros. Macro viruses infect Microsoft Office files, and propagate once the file is opened
  * __Polymorphic viruses__ - Viruses that can change their form to evade detection
* __Trojans__ - Malware that hides in legitimate files, named after the famous Trojan Horse from Greek mythology
* __Worms__ - Malware that is similar to viruses, but does not require human intervention to propagate - they spread themselves through a system on their own
* __Spam__ - Malware that is stored inside email attachments or links, usually tricking a user to click a link or download a program
* __Ransomware__ - Malware that encrypts data on a system, and kindly requests users to pay a ransom to get their data back, usually in the form of cryptocurrencies.
* __Rootkits__ - Malware that functions as a Swiss army knife - they embed themselves deep into a system, often onto the kernel itself, and allow threat actors complete control over a system
* __Adware__ - One of the most common types of malware infection, these will cause unwanted advertisements to pop up all over a computer system
* __Spyware__ - Malware that quietly infects a system and sends personal data back to threat actors. This category includes keyloggers, which record all keystrokes typed by a user and sends these back to the threat actor.

### Malware Attack Chain

When malware infects a system it will usually follow a similar pattern, often leaving a trail of crumbs for malware analysts to follow. The steps most malware will go through are:

* __Delivery__ - The method by which the malware gains initial access to a system
> For example, USB sticks (like Stuxnet) and email attachments from phishing emails

* __Execution__ - The main part of malware classification, this is what the malware actually does to a system
>For example, ransomware will encrypt files and spyware will record and transmit data such as keystrokes.

* __Persistence__ - Usually malware will want to stay in the target system without being detected for further attack.
>Malware can often be found hiding in parts of a system like the registry and startup programs.

* __Propagation__ - The method by which malware will spread to other avaliable devices
> The BlackBasta Ransomware can spread through local Windows machines by connecting to Active Directory, scanning for other computers on a local network, copy the malware onto them, then run them remotely with the [Component Object Model (COM)](https://learn.microsoft.com/en-us/windows/win32/com/component-object-model--com--portal). Trend Micro have a [fascinating analysis](https://www.trendmicro.com/en_no/research/22/e/examining-the-black-basta-ransomwares-infection-routine.html) of the BlackBasta ransomware.

This whole attack chain will leave signatures behind, both host-based and network-based:
* __Host-based__ - the results of any execution or persistence, such as encrypted files and additional installed software
>For example, automated vulnerability scans and enumeration on a system often leave a very obvious trail, and can usually be considered an indicator of compromise

* __Network-based__ - this includes any networking communications made during delivery, execution and propagation, for example connecting to a C2 server, or ransomware contacting victims for cryptocurrency payments
>__C2 servers__, or command and control servers, are servers run by threat actors to send additional instructions to small persistent programs hidden in a system called __beacons__.

### Malware Analysis

Now for some actual malware analysis. There are two types of malware analysis:
1. __Static analysis__ - analysis of the state of the malware sample before any execution. This is used to get a high-level understanding of a piece of malware
>This uses techniques such as _signature analysis_ - all files can be hashed to generate a checksum and compared against other known hashes. Organisations such as Virustotal have a library of known malware hashes. More on this to come...

2. __Dynamic analysis__ - analysis of malware whilst it is being executed. This is much more involved and dangerous, and should always be carried out in a _sandbox_ - an isolated environment where any malware can’t affect your real data, such as a virtual machine.

### MD5 Checksums

Taking the MD5 hash of a file is like taking a cryptographic fingerprint. The checksum will be a 32 character hexadecimal number. If two files have the same checksum, there is a high probability that the files are the same.

>MD5 is a hashing algorithm. Hashing algorithms are ‘one-way functions’. It is easy to compute the hash of an input, but computationally difficult to go backwards. For this reason, hash functions are ubiquitous in cryptography. Hash functions also have the property that a tiny change in an input will result in a completely different output. This makes hashing useful for fingerprinting files.

On Linux, the ```md5sum``` command will compute the MD5 checksum of a file. In the example below, I have created two text files ```file1.txt``` and ```file2.txt```, each with different content. Next, the ```md5sum``` command is used. Observe that the two files each have completely different checksums.

```
┌──(kali㉿kali)-[~/Documents]
└─$ echo 'bees' > file1.txt

┌──(kali㉿kali)-[~/Documents]
└─$ echo 'honey' > file2.txt

┌──(kali㉿kali)-[~/Documents]
└─$ md5sum file1.txt
cd4c78001a0a37a39c44154f7b680785  file1.txt

┌──(kali㉿kali)-[~/Documents]
└─$ md5sum file2.txt
069cfc88dd2a624d8963fb9657ecfa74  file2.txt
```

In the next example, I have created a third file, ```file3.txt```, and given it the same content as ```file1.txt``` - ```bees```. When the MD5 checksum is computed, note that the result is the same as ```file1.txt```.

```
┌──(kali㉿kali)-[~/Documents]
└─$ echo 'bees' > file3.txt

┌──(kali㉿kali)-[~/Documents]
└─$ md5sum file3.txt
cd4c78001a0a37a39c44154f7b680785  file3.txt
```

MD5 checksums allow uniform identification of malware for the malware analysis community. Organisations like __Virustotal__ will collect and analyse malware, and publish their checksums for users to observe and compare to. If you are a malware analyst and come across a nasty unfamiliar piece of malware, you can [upload it to Virustotal](https://www.virustotal.com/gui/home/upload) . If someone else has come across this malware before and uploaded it, you will have their analysis ready for you.

#### MD5 Checksums Example

These examples have been provided by Tryhackme's Malware Analysis module.

These three files are common enough looking executables. They are named ```aws.exe```, ```NetLogo.exe``` and ```vlc.exe```. For example, VLC is a legitimate Windows media player.

![alt text](\assets\img\cybersecurity\malware\files.PNG)

Let’s check out their MD5 checksums to see if they are who they say they are.

__HashTab__ is a Windows application for computing hashes of files. It is an extension to Windows explorer, and appears as an additional tab in a file’s ```properties``` window. HashTab can be [downloaded from here](https://www.majorgeeks.com/files/details/hashtab.html). HashTab will compute checksums with various hashing algorithms, and allows you to compare the hashes of two files.

![alt text](\assets\img\cybersecurity\malware\aws.PNG)
![alt text](\assets\img\cybersecurity\malware\netlogo.PNG)
![alt text](\assets\img\cybersecurity\malware\vlc.PNG)

On each of the above screenshots, we can see the MD5 checksums of each file. We see that the hashes are

```
aws.exe - D2778164EF643BA8F44CC202EC7EF157
NetLogo.exe - 59CB421172A89E1E16C11A428326952C
vlc.exe - 5416BE1B8B04B1681CB39CF0E2CAAD9F
```

We can now upload these hashes to Virustotal to check if they have been previously flagged as malicious.

![alt text](\assets\img\cybersecurity\malware\netlogo_vt.PNG)
![alt text](\assets\img\cybersecurity\malware\netlogo_vt_res.PNG)

We see that Virustotal does not mark this file as malicious. The same result occurs for all three example files. Note that just because a file was not marked as malicious, doesn’t mean it is harmless. This just means that no vendors or sandboxes on Virustotal were able to find anything malicious. There are many ways for threat actors to hide the true purpose of their malware.

### Magic Numbers
Just because a file tells you it is an executable doesn’t mean it really is one. Likewise, just because a file tells you it is a cute cat JPG file, doesn’t mean it is not a malicious executable.
